<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íŒŒì´ë¦¬ ìº¡ì²˜ v3.0.7</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"/>
    <style>
        /* --- ê³µí†µ ë ˆì´ì•„ì›ƒ --- */
        body { font-family: 'Pretendard', 'Malgun Gothic', sans-serif; margin: 0; padding: 0; background: #2b2b2b; color: white; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .container { width: 98%; height: 96vh; max-width: 1800px; background: #fdfdfd; color: #333; padding: 0; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 15px 40px rgba(0,0,0,0.7); overflow: hidden; }
        button, label, input[type="radio"] + label, .segment-item, .merge-item-wrap, .q-btn, .view-btn, .viewer-panel { cursor: pointer !important; }

        /* í—¤ë” */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 5px 20px; border-bottom: 1px solid #e0e0e0; background: #fff; flex-shrink: 0; height: 45px; }
        .brand-group { display: flex; align-items: center; gap: 10px; }
        .brand-icon { width: 32px; height: 32px; object-fit: contain; }
        h3 { margin: 0; font-size: 18px; font-weight: 800; color: #333; }
        .view-mode-group { display: flex; background: #f1f3f5; padding: 3px; border-radius: 8px; gap: 0; border: 1px solid #e9ecef;}
        .view-btn { padding: 4px 10px; border: none; background: transparent; font-weight: 600; font-size: 12px; border-radius: 6px; color: #868e96; }
        .view-btn.active { background: #343a40; color: white; }
        .btn-dir { background-color: #495057; color: white; border: none; padding: 5px 12px; border-radius: 6px; font-weight: bold; font-size: 12px; }
        .btn-dir.connected { background-color: #198754; }

        /* íŒŒì¼ëª… ì„¤ì • ë°” */
        .naming-bar { display: flex; align-items: center; padding: 8px 20px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; gap: 15px; flex-shrink: 0; height: 40px; }
        .btn-add-seg { font-size: 11px; padding: 3px 8px; border: none; border-radius: 4px; font-weight: bold; color: white; }
        .btn-add-text { background: #6c757d; } .btn-add-page { background: #0d6efd; } .btn-add-num  { background: #fd7e14; } 
        .btn-reset { background: white; color: #dc3545; border: 1px solid #dc3545; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;}
        .segment-container { display: flex; align-items: center; gap: 4px; flex: 1; overflow-x: auto; }
        .segment-item { display: flex; align-items: center; padding: 2px 6px; border-radius: 4px; border: 1px solid #dee2e6; gap: 3px; font-size: 11px; background: white; }
        .preview-box { font-size: 13px; font-weight: bold; color: #d63384; background: white; padding: 4px 10px; border: 1px solid #ddd; border-radius: 4px; margin-left: auto;}

        /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
        .layout-body { display: flex; flex: 1; overflow: hidden; position: relative; }
        .viewers-container { flex: 1; display: flex; overflow: hidden; position: relative; background: #e9ecef;}
        .viewer-panel { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #dee2e6; position: relative; background: #f8f9fa; min-width: 0; border: 2px solid transparent; }
        .viewer-panel.active-focus { border-color: #0d6efd; box-shadow: inset 0 0 0 2px #0d6efd; z-index: 5; } 
        .viewer-toolbar { padding: 6px 10px; background: #fff; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; font-size: 12px; height: 36px; }
        .active-badge { display: none; background: #0d6efd; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; }
        .viewer-panel.active-focus .active-badge { display: inline-block; }
        .page-nav { display: flex; align-items: center; gap: 4px; background: rgba(255,255,255,0.5); padding: 2px 5px; border-radius: 4px;}
        .page-input { width: 35px; text-align: center; padding: 2px; border: 1px solid #ced4da; border-radius: 3px; font-weight: bold; font-size: 12px;}
        .mini-btn { padding: 3px 8px; border: 1px solid #ced4da; background: white; border-radius: 3px; font-size: 11px; font-weight: bold; color: #495057; }
        .work-area { flex: 1; position: relative; overflow: hidden; background: #343a40; display: flex; justify-content: center; align-items: center; }
        .work-area img { display: block; max-width: 100%; }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; background: rgba(0,0,0,0.8); padding: 15px 30px; border-radius: 10px; display: none; z-index: 100; }

        /* ì‚¬ì´ë“œë°” */
        .layout-right { width: 320px; background: #fff; border-left: 1px solid #dee2e6; display: flex; flex-direction: column; padding: 15px; gap: 15px; }
        .section-title { font-size: 11px; font-weight: 800; color: #868e96; margin-bottom: 5px; text-transform: uppercase;}
        .settings-box { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; }
        .num-input { width: 55px; text-align: right; padding: 4px; border: 1px solid #ced4da; border-radius: 4px; font-weight: bold; font-size: 12px; }

        .queue-box { flex: 1; display: flex; flex-direction: column; border: 1px solid #ffeeba; background: #fffcf5; border-radius: 8px; overflow: hidden; }
        .queue-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: #fff3cd; }
        .merge-list { flex: 1; overflow-y: auto; padding: 5px; display: flex; flex-direction: column; gap: 5px; }
        .merge-item-wrap { display: flex; align-items: center; background: white; border: 1px solid #eee; border-radius: 6px; padding: 4px; gap: 8px; font-size: 11px;}
        
        .action-area { display: flex; flex-direction: column; gap: 10px; margin-top: auto; }
        .toggle-group { display: flex; background: #f1f3f5; padding: 4px; border-radius: 8px; gap: 2px; }
        .toggle-item { flex: 1; text-align: center; }
        .toggle-item input { display: none; }
        .toggle-item label { display: block; padding: 8px 0; border-radius: 6px; font-size: 12px; font-weight: bold; color: #868e96; }
        .toggle-item input:checked + label { background: white; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.08); }
        .main-btn { padding: 14px; font-weight: 800; border: none; border-radius: 8px; color: white; font-size: 15px; width: 100%; transition: 0.2s; cursor: pointer;}
        .btn-direct { background: #0d6efd; } .btn-merge { background: #198754; }
        
        .status-msg { font-size: 13px; font-weight: bold; text-align: center; height: 18px; color: #0d6efd;}
        .mode-indicator { font-size: 11px; color: #333; text-align: left; background: #fff3cd; padding: 8px; border-radius: 4px; border: 1px solid #ffeeba; line-height: 1.5; }
        .key-badge { background: #333; color: white; padding: 1px 4px; border-radius: 3px; font-family: monospace; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="brand-group">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/4.png" alt="Charmander" class="brand-icon">
            <h3>íŒŒì´ë¦¬ ìº¡ì²˜ v3.0.7</h3>
            <div class="view-mode-group">
                <button class="view-btn active" id="btnSingle" onclick="setLayout('single')">ë‹¨ì¼í™”ë©´</button>
                <button class="view-btn" id="btnDual" onclick="setLayout('dual')">ë“€ì–¼ëª¨ë“œ</button>
            </div>
        </div>
        <button id="btnSetDir" class="btn-dir">ğŸ“‚ ì €ì¥ í´ë” ì—°ê²°</button>
    </div>

    <div class="naming-bar">
        <div class="naming-group">
            <button class="btn-add-seg btn-add-text" onclick="addSegment('text')">+Txt</button>
            <button class="btn-add-seg btn-add-page" onclick="addSegment('page')">+Page</button>
            <button class="btn-add-seg btn-add-num" onclick="addSegment('number')">+Num</button>
            <button class="btn-reset" onclick="resetSegments()">R</button>
        </div>
        <div style="display:flex; align-items:center; gap:3px;">
            <input type="checkbox" id="chkAutoPage" checked onchange="toggleAutoPage()">
            <label for="chkAutoPage" style="font-size:11px; color:#0d6efd; font-weight:bold;">P:Auto</label>
        </div>
        <div id="segmentContainer" class="segment-container"></div>
        <div id="previewName" class="preview-box">...</div>
    </div>

    <div class="layout-body">
        <div class="viewers-container">
            <div class="viewer-panel active-focus" id="panel1" onclick="setFocus(1)">
                <div class="viewer-toolbar">
                    <input type="file" id="file1" accept="application/pdf">
                    <div class="page-nav">
                        <button class="mini-btn" onclick="navPage(1, -1)">â—€</button>
                        <input type="number" id="pageIn1" class="page-input" value="1" onkeydown="if(event.key==='Enter') jumpPage(1)">
                        <span id="total1" style="font-size:11px;">/ 0</span>
                        <button class="mini-btn" onclick="navPage(1, 1)">â–¶</button>
                    </div>
                    <span style="font-weight:bold; color:#0d6efd; font-size:11px;">V1 <span class="active-badge">Active</span></span>
                </div>
                <div class="work-area" id="workArea1"><div id="load1" class="loading">Loading...</div><img id="img1" src=""></div>
            </div>
            <div class="viewer-panel" id="panel2" style="display:none;" onclick="setFocus(2)">
                <div class="viewer-toolbar">
                    <input type="file" id="file2" accept="application/pdf">
                    <div class="page-nav">
                        <button class="mini-btn" onclick="navPage(2, -1)">â—€</button>
                        <input type="number" id="pageIn2" class="page-input" value="1" onkeydown="if(event.key==='Enter') jumpPage(2)">
                        <span id="total2" style="font-size:11px;">/ 0</span>
                        <button class="mini-btn" onclick="navPage(2, 1)">â–¶</button>
                    </div>
                    <span style="font-weight:bold; color:#fd7e14; font-size:11px;">V2 <span class="active-badge">Active</span></span>
                </div>
                <div class="work-area" id="workArea2"><div id="load2" class="loading">Loading...</div><img id="img2" src=""></div>
            </div>
        </div>

        <div class="layout-right">
            <div class="section-title">ì„¤ì • 1 (Zoom & Size - ìœ ì§€)</div>
            <div class="settings-box">
                <div class="setting-row">
                    <span style="font-size:12px; font-weight:bold;">Zoom</span>
                    <div><input type="number" id="zoomInput" class="num-input" value="100"> %</div>
                </div>
                <div class="setting-row">
                    <span style="font-size:12px; font-weight:bold;">Size</span>
                    <div style="font-size:11px;">W <input type="number" id="cropW" class="num-input" style="width:45px;"> H <input type="number" id="cropH" class="num-input" style="width:45px;"></div>
                </div>
                <button class="mini-btn" onclick="fitToWidth()">ê°€ë¡œ ë§ì¶¤</button>
            </div>

            <div class="section-title">ì„¤ì • 2 (íšŒì „ - í˜ì´ì§€ ì´ë™ ì‹œ ë¦¬ì…‹)</div>
            <div class="settings-box">
                <div class="setting-row">
                    <span style="font-size:12px; font-weight:bold;">Rotate</span>
                    <div><input type="number" id="rotateInput" class="num-input" value="0" step="0.1"> Â°</div>
                </div>
            </div>

            <div class="queue-box">
                <div class="queue-header"><span style="font-weight:bold; font-size:12px;">ëŒ€ê¸°ì—´ <span id="qCount">0</span></span><button class="mini-btn" onclick="clearQueue()">ë¹„ìš°ê¸°</button></div>
                <div id="queueList" class="merge-list"></div>
            </div>

            <div class="action-area">
                <div class="mode-indicator" id="modeIndicator">
                    <span class="key-badge">1</span> ì¦‰ì‹œì‹¤í–‰ | <span class="key-badge">2</span> ëŒ€ê¸°ì—´ | <span class="key-badge">3</span> í•©ì³ì €ì¥<br>
                    <span class="key-badge">A</span> ìœ„ì¹˜ | <span class="key-badge">W</span> ë„ˆë¹„ | <span class="key-badge">H</span> ë†’ì´ | <span class="key-badge">R</span> íšŒì „
                </div>
                <div class="toggle-group">
                    <div class="toggle-item"><input type="radio" name="capMode" id="cmDirect" value="direct" checked onchange="updateUI()"><label for="cmDirect">ì¦‰ì‹œ ì‹¤í–‰ (1)</label></div>
                    <div class="toggle-item"><input type="radio" name="capMode" id="cmQueue" value="queue" onchange="updateUI()"><label for="cmQueue">ëŒ€ê¸°ì—´ ë‹´ê¸° (2)</label></div>
                </div>
                <div class="toggle-group">
                    <div class="toggle-item"><input type="radio" name="actMode" id="amSave" value="save" checked onchange="updateUI()"><label for="amSave">íŒŒì¼ ì €ì¥</label></div>
                    <div class="toggle-item"><input type="radio" name="actMode" id="amCopy" value="copy" onchange="updateUI()"><label for="amCopy">ë³µì‚¬</label></div>
                </div>
                <button id="btnMain" class="main-btn btn-direct" onclick="executeMain()">ğŸš€ ì‹¤í–‰ (Enter)</button>
                <button id="btnMerge" class="main-btn btn-merge" style="display:none;" onclick="executeMerge()">ğŸ”— í•©ì³ì„œ ì €ì¥ (3)</button>
                <div id="statusMsg" class="status-msg"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const state = {
        1: { pdf: null, page: 1, cropper: null, locked: false, lastZoom: 1.0, box: null, lastW: 300, lastH: 200 },
        2: { pdf: null, page: 1, cropper: null, locked: false, lastZoom: 1.0, box: null, lastW: 300, lastH: 200 }
    };
    
    let activeId = 1;
    let queue = [];
    let dirHandle = null;
    let arrowMode = 'a'; // a, w, h, r
    let isAutoPage = true;
    let segments = [{id:1,type:'text',value:'ssen',digits:0},{id:2,type:'text',value:'_',digits:0},{id:3,type:'page',value:1,digits:2},{id:4,type:'number',value:1,digits:2}];

    async function renderPage(id, num) {
        const s = state[id];
        if(!s.pdf || s.locked) return;
        s.locked = true;
        document.getElementById(`load${id}`).style.display = 'block';

        if(s.cropper) {
            const data = s.cropper.getData();
            s.lastW = data.width;
            s.lastH = data.height;
            const canvasData = s.cropper.getCanvasData();
            const imgData = s.cropper.getImageData();
            s.lastZoom = canvasData.width / imgData.naturalWidth;
            s.box = s.cropper.getCropBoxData();
            s.cropper.destroy(); s.cropper = null;
        }

        try {
            s.page = num;
            document.getElementById(`pageIn${id}`).value = num;
            if(id === 1 && isAutoPage) {
                const seg = segments.find(s=>s.type==='page');
                if(seg) { seg.value = num; renderSegments(); }
            }
            const page = await s.pdf.getPage(num);
            const viewport = page.getViewport({ scale: 3.0 });
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width; canvas.height = viewport.height;
            await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

            const imgEl = document.getElementById(`img${id}`);
            imgEl.src = canvas.toDataURL('image/jpeg');
            imgEl.onload = () => {
                document.getElementById(`load${id}`).style.display = 'none';
                initCropper(id);
                s.locked = false;
            }
        } catch(e) { s.locked = false; }
    }

    function initCropper(id) {
        const s = state[id];
        const imgEl = document.getElementById(`img${id}`);
        s.cropper = new Cropper(imgEl, {
            viewMode: 0, dragMode: 'move', autoCropArea: 0.2, background: false, zoomOnWheel: false,
            ready() {
                this.cropper.zoomTo(s.lastZoom);
                this.cropper.rotateTo(0); 
                this.cropper.setData({ width: s.lastW, height: s.lastH });
                if(s.box) this.cropper.setCropBoxData({ left: s.box.left, top: s.box.top });
                if(id === activeId) updateSettingsUI();
            },
            crop(e) { if(id === activeId) updateCropInputs(e.detail); }
        });
    }

    // ë§ˆìš°ìŠ¤ íœ  í˜ì´ì§€ íƒìƒ‰
    ['workArea1', 'workArea2'].forEach(areaId => {
        const area = document.getElementById(areaId);
        const id = areaId === 'workArea1' ? 1 : 2;
        area.addEventListener('wheel', (e) => {
            const c = state[id].cropper;
            if(!c) return;
            e.preventDefault();
            setFocus(id);
            if(e.ctrlKey) {
                c.zoom(e.deltaY > 0 ? -0.05 : 0.05);
            } else {
                const can = c.getCanvasData();
                const con = c.getContainerData();
                if(e.deltaY > 0) { 
                    if(can.top + can.height <= con.height + 15) navPage(id, 1);
                    else c.move(0, -20);
                } else {
                    if(can.top >= -15) navPage(id, -1);
                    else c.move(0, 20);
                }
            }
        }, {passive:false});
    });

    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
    document.addEventListener('keydown', (e) => {
        if(e.target.tagName === 'INPUT') return;
        const key = e.key.toLowerCase();

        // 1, 2, 3 ë‹¨ì¶•í‚¤
        if(key === '1') {
            document.getElementById('cmDirect').checked = true;
            updateUI();
            msg("ëª¨ë“œ: ì¦‰ì‹œ ì‹¤í–‰", "success");
            return;
        }
        if(key === '2') {
            document.getElementById('cmQueue').checked = true;
            updateUI();
            msg("ëª¨ë“œ: ëŒ€ê¸°ì—´ ë‹´ê¸°", "success");
            return;
        }
        if(key === '3') {
            executeMerge();
            return;
        }

        // ì„¤ì • ëª¨ë“œ ì „í™˜
        if(['a','w','h','r'].includes(key)) {
            arrowMode = key;
            updateModeIndicator();
            return;
        }

        // ë°©í–¥í‚¤ ì¡°ì ˆ
        if(['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
            e.preventDefault();
            const c = state[activeId].cropper;
            if(!c) return;
            const step = e.shiftKey ? 10 : 1;
            const rStep = e.shiftKey ? 1.0 : 0.1;

            if(arrowMode === 'a') { // ìœ„ì¹˜ ì´ë™
                const b = c.getCropBoxData();
                if(e.key==='ArrowUp') b.top-=step; if(e.key==='ArrowDown') b.top+=step;
                if(e.key==='ArrowLeft') b.left-=step; if(e.key==='ArrowRight') b.left+=step;
                c.setCropBoxData(b);
            } 
            else if(arrowMode === 'w') { // ë„ˆë¹„ ì¡°ì ˆ
                const d = c.getData();
                if(e.key==='ArrowLeft' || e.key==='ArrowDown') d.width-=step;
                if(e.key==='ArrowRight' || e.key==='ArrowUp') d.width+=step;
                c.setData({ width: d.width });
            }
            else if(arrowMode === 'h') { // ë†’ì´ ì¡°ì ˆ
                const d = c.getData();
                // [ìˆ˜ì •ì‚¬í•­] ìœ„ ì‘ê²Œ, ì•„ë˜ í¬ê²Œ
                if(e.key==='ArrowUp' || e.key==='ArrowLeft') d.height-=step; 
                if(e.key==='ArrowDown' || e.key==='ArrowRight') d.height+=step;
                c.setData({ height: d.height });
            }
            else if(arrowMode === 'r') { // íšŒì „
                let rot = c.getData().rotate;
                if(e.key==='ArrowUp' || e.key==='ArrowRight') rot+=rStep;
                if(e.key==='ArrowDown' || e.key==='ArrowLeft') rot-=rStep;
                c.rotateTo(rot);
            }
            updateSettingsUI();
        }
        if(e.key === 'Enter') executeMain();
    });

    function updateModeIndicator() {
        const el = document.getElementById('modeIndicator');
        const desc = {
            'a': '<span class="key-badge" style="background:#0d6efd">A</span> <b>ìœ„ì¹˜ ì´ë™ ëª¨ë“œ</b>',
            'w': '<span class="key-badge" style="background:#fd7e14">W</span> <b>ë„ˆë¹„(Width) ì¡°ì ˆ ëª¨ë“œ</b>',
            'h': '<span class="key-badge" style="background:#6f42c1">H</span> <b>ë†’ì´(Height) ì¡°ì ˆ ëª¨ë“œ</b>',
            'r': '<span class="key-badge" style="background:#198754">R</span> <b>íšŒì „(Rotate) ì¡°ì ˆ ëª¨ë“œ</b>'
        };
        el.innerHTML = desc[arrowMode] + "<br><small>1,2: ëª¨ë“œë³€ê²½ | 3: í•©ì³ì €ì¥ | ë°©í–¥í‚¤ ì¡°ì ˆ</small>";
    }

    // ì…ë ¥ì°½ ì‹¤ì‹œê°„ ë°˜ì˜
    document.getElementById('zoomInput').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        if(state[activeId].cropper && !isNaN(val)) {
            state[activeId].cropper.zoomTo(val / 100);
            state[activeId].lastZoom = val / 100;
        }
    });
    document.getElementById('rotateInput').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        if(state[activeId].cropper && !isNaN(val)) state[activeId].cropper.rotateTo(val);
    });
    ['cropW', 'cropH'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
            const c = state[activeId].cropper;
            const w = parseFloat(document.getElementById('cropW').value);
            const h = parseFloat(document.getElementById('cropH').value);
            if(c && !isNaN(w) && !isNaN(h)) {
                c.setData({ width: w, height: h });
                state[activeId].lastW = w; state[activeId].lastH = h;
            }
        });
    });

    function updateSettingsUI() {
        const c = state[activeId].cropper;
        if(!c) return;
        const imgData = c.getImageData();
        const cvsData = c.getCanvasData();
        document.getElementById('zoomInput').value = Math.round((cvsData.width / imgData.naturalWidth) * 100);
        document.getElementById('rotateInput').value = c.getData().rotate.toFixed(1);
        const d = c.getData();
        document.getElementById('cropW').value = Math.round(d.width);
        document.getElementById('cropH').value = Math.round(d.height);
    }
    function updateCropInputs(data) {
        document.getElementById('cropW').value = Math.round(data.width);
        document.getElementById('cropH').value = Math.round(data.height);
    }
    function setFocus(id) {
        activeId = id;
        document.querySelectorAll('.viewer-panel').forEach((p, idx) => p.classList.toggle('active-focus', (idx+1)===id));
        updateSettingsUI();
    }
    function setLayout(mode) {
        document.getElementById('btnSingle').classList.toggle('active', mode==='single');
        document.getElementById('btnDual').classList.toggle('active', mode==='dual');
        document.getElementById('panel2').style.display = (mode==='dual') ? 'flex' : 'none';
        if(mode==='single') setFocus(1);
    }
    document.getElementById('file1').onchange = (e) => loadPdf(1, e.target.files[0]);
    document.getElementById('file2').onchange = (e) => loadPdf(2, e.target.files[0]);
    async function loadPdf(id, file) { if(!file) return; const ab = await file.arrayBuffer(); state[id].pdf = await pdfjsLib.getDocument(ab).promise; document.getElementById(`total${id}`).innerText = `/ ${state[id].pdf.numPages}`; renderPage(id, 1); }
    function navPage(id, delta) { const next = state[id].page + delta; if(state[id].pdf && next >= 1 && next <= state[id].pdf.numPages) renderPage(id, next); }
    function jumpPage(id) { const val = parseInt(document.getElementById(`pageIn${id}`).value); if(state[id].pdf && val >= 1 && val <= state[id].pdf.numPages) renderPage(id, val); }
    function fitToWidth() { 
        const c = state[activeId].cropper; 
        if(!c) return; 
        const con = c.getContainerData(); 
        const img = c.getImageData(); 
        const ratio = con.width / img.naturalWidth;
        c.zoomTo(ratio);
        state[activeId].lastZoom = ratio;
        updateSettingsUI();
    }

    window.updateUI = () => {
        const capMode = document.querySelector('input[name="capMode"]:checked').value;
        document.getElementById('btnMerge').style.display = (capMode==='queue' && queue.length > 0) ? 'block' : 'none';
        const btnMain = document.getElementById('btnMain');
        const actMode = document.querySelector('input[name="actMode"]:checked').value;
        if(capMode === 'direct') {
            btnMain.innerText = actMode === 'save' ? "ğŸš€ ì¦‰ì‹œ ì €ì¥ (Enter)" : "ğŸš€ ì¦‰ì‹œ ë³µì‚¬ (Enter)";
            btnMain.className = "main-btn btn-direct";
        } else {
            btnMain.innerText = "â• ëŒ€ê¸°ì—´ ë‹´ê¸° (Enter)";
            btnMain.className = "main-btn btn-queue";
        }
    };

    window.executeMain = async () => {
        const c = state[activeId].cropper;
        if(!c) return;
        const capMode = document.querySelector('input[name="capMode"]:checked').value;
        const actMode = document.querySelector('input[name="actMode"]:checked').value;
        const cvs = c.getCroppedCanvas();
        if(capMode === 'direct') {
            const blob = await new Promise(r=>cvs.toBlob(r, 'image/png'));
            if(actMode === 'save') await saveFile(blob); else await copyBlob(blob);
        } else {
            queue.push({ src: cvs.toDataURL(), w:cvs.width, h:cvs.height });
            renderQueue();
            msg("ëŒ€ê¸°ì—´ ì¶”ê°€ë¨", "success");
        }
    };

    window.executeMerge = async () => {
        if(queue.length === 0) return;
        const maxW = Math.max(...queue.map(i=>i.w));
        const totalH = queue.reduce((a,b)=>a+b.h, 0);
        const cvs = document.createElement('canvas');
        cvs.width = maxW; cvs.height = totalH;
        const ctx = cvs.getContext('2d');
        let y=0;
        for(let item of queue) {
            const img = await new Promise(r => { const i=new Image(); i.onload=()=>r(i); i.src=item.src; });
            ctx.drawImage(img, 0, y); y += item.h;
        }
        const blob = await new Promise(r=>cvs.toBlob(r));
        const actMode = document.querySelector('input[name="actMode"]:checked').value;
        if(actMode === 'save') await saveFile(blob); else await copyBlob(blob);
        queue = []; renderQueue();
    };

    async function saveFile(blob) {
        if(!dirHandle) { alert('ì €ì¥ í´ë”ë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.'); return; }
        try {
            const fh = await dirHandle.getFileHandle(getFilename(), {create:true});
            const wr = await fh.createWritable();
            await wr.write(blob); await wr.close();
            msg('ì €ì¥ ì™„ë£Œ', 'success'); nextNum();
        } catch(e) { alert('ì €ì¥ ì‹¤íŒ¨'); }
    }
    async function copyBlob(blob) {
        try {
            await navigator.clipboard.write([new ClipboardItem({'image/png':blob})]);
            msg('ë³µì‚¬ ì™„ë£Œ', 'copy'); nextNum();
        } catch(e) { alert('ë³µì‚¬ ì‹¤íŒ¨'); }
    }
    function renderQueue() {
        const list = document.getElementById('queueList');
        document.getElementById('qCount').innerText = queue.length;
        list.innerHTML = queue.map((item, idx) => `<div class="merge-item-wrap"><img src="${item.src}" height="30"> <span>Image ${idx+1}</span></div>`).join('');
        updateUI();
    }
    function clearQueue() { queue=[]; renderQueue(); }
    function getFilename() {
        let n = '';
        segments.forEach(s => { if(s.type==='text') n+=s.value; else n+=s.value.toString().padStart(s.digits||1,'0'); });
        return n + '.png';
    }
    function nextNum() { segments.forEach(s=>{if(s.type==='number')s.value++}); renderSegments(); }
    function msg(txt, type) { const el = document.getElementById('statusMsg'); el.innerText = txt; setTimeout(()=>el.innerText='',1500); }
    function toggleAutoPage() { isAutoPage = document.getElementById('chkAutoPage').checked; }
    function addSegment(t) { segments.push({type:t, value:1, digits:1}); renderSegments(); }
    function resetSegments() { segments=[{id:1,type:'text',value:'ssen',digits:0},{id:2,type:'text',value:'_',digits:0},{id:3,type:'page',value:1,digits:2},{id:4,type:'number',value:1,digits:2}]; renderSegments(); }
    function renderSegments() {
        const cont = document.getElementById('segmentContainer');
        cont.innerHTML = segments.map((s, i) => `<div class="segment-item"><span>${s.type}</span><input class="seg-input" value="${s.value}" onchange="segments[${i}].value=this.value;renderSegments();"></div>`).join('');
        document.getElementById('previewName').innerText = getFilename();
    }
    document.getElementById('btnSetDir').onclick = async () => { try { dirHandle = await window.showDirectoryPicker(); document.getElementById('btnSetDir').innerText = dirHandle.name; document.getElementById('btnSetDir').classList.add('connected'); } catch(e){} };

    renderSegments(); updateUI(); setLayout('single'); updateModeIndicator();
</script>
</body>
</html>